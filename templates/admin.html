<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M3U Playlist Admin</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        body {
            font-family: sans-serif;
            margin: 10px;
            line-height: 1.5;
            font-size: 0.95em; /* Base font size for form area */
            max-width: 100%;
            overflow-x: hidden;
            background-color: #f4f4f4;
        }
        h1, h2 {
            color: #333;
            margin-top: 15px;
            margin-bottom: 10px;
            font-size: 1.5em;
        }
        h2 {
            font-size: 1.3em;
        }

        /* --- Form Styles (Mostly Unchanged) --- */
        form#channel-form {
            margin-bottom: 15px;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #fff;
            box-sizing: border-box;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        form#channel-form label {
            display: block;
            margin-bottom: 4px;
            font-weight: bold;
            color: #555;
            font-size: 0.9em;
        }
        form#channel-form input[type="text"] {
            width: 100%;
            padding: 6px 8px;
            margin-bottom: 8px;
            border: 1px solid #ccc;
            border-radius: 3px;
            font-size: 0.95em;
            box-sizing: border-box;
        }
        form#channel-form input[type="text"]:focus {
            border-color: #007bff;
            outline: none;
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
        }
        form#channel-form button {
            padding: 5px 10px;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.9em;
            margin-right: 5px;
            margin-bottom: 5px;
            vertical-align: middle;
            transition: background-color 0.2s ease;
        }
        form#channel-form button i {
            margin-right: 4px;
        }
        form#channel-form button:hover {
            opacity: 0.85;
        }
        #submit-button { background-color: #28a745; }
        #submit-button.update-mode { background-color: #007bff; }
        #cancel-edit-button { background-color: #ffc107; color: #333; display: none; }
        #cancel-edit-button:hover { background-color: #e0a800; }

        /* --- M3U Link Style --- */
        .m3u-link {
            margin-top: 10px;
            margin-bottom: 15px;
            font-size: 0.9em;
            background-color: #e9f2f7;
            padding: 8px 10px;
            border-left: 4px solid #007bff;
            word-break: break-all; /* URL যেন ভেঙ্গে পরের লাইনে যায় */
            line-height: 1.4; /* URL লম্বা হলে লাইন হাইট ঠিক রাখা */
        }
        .m3u-link a {
            color: #0056b3;
            text-decoration: none;
            /* font-weight: bold; */ /* বোল্ড বাদ দেওয়া হলো */
        }
        .m3u-link a:hover {
            text-decoration: underline;
        }

        /* --- Table Styles (Made More Compact) --- */
        .table-container { /* Wrapper div for overflow */
             overflow-x: auto;
             width: 100%;
             margin-top: 15px;
        }
        table#channels-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.80em; /* টেবিলের ফন্ট সাইজ আরও কমানো হলো */
            line-height: 1.3; /* টেবিলের লাইন হাইট কমানো হলো */
            background-color: #fff;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        #channels-table th,
        #channels-table td {
            border: 1px solid #ddd;
            padding: 2px 5px; /* সেলের প্যাডিং আরও কমানো হলো */
            text-align: left;
            word-break: break-word;
            vertical-align: middle;
        }
        #channels-table th {
            background-color: #e9ecef;
            font-weight: 600;
            white-space: nowrap; /* হেডার যেন এক লাইনে থাকে */
            padding: 3px 5px; /* হেডারের প্যাডিং সামান্য বেশি */
        }
        #channels-table tr:nth-child(even) {
            background-color: #f8f9fa;
        }
         #channels-table tr.editing {
             background-color: #cfe2ff;
         }
         #channels-table img {
            max-height: 20px; /* Logo height আরও কমানো হলো */
            max-width: 40px; /* Max width for logo */
            vertical-align: middle;
            background-color: #eee;
            border-radius: 2px;
         }
         /* Stream Link Column Width (Optional) */
         /*
         #channels-table th:nth-child(5),
         #channels-table td:nth-child(5) {
             min-width: 150px; // or some other value
             max-width: 250px;
             overflow: hidden;
             text-overflow: ellipsis;
             white-space: nowrap;
         }
         #channels-table td:nth-child(5) {
             cursor: help; // Indicate full link is in title
         }
         */

        /* --- Action Buttons in Table (Made More Compact) --- */
        #channels-table .actions {
            white-space: nowrap;
            text-align: center;
        }
        #channels-table .actions button {
            padding: 2px 6px; /* অ্যাকশন বাটনের প্যাডিং আরও কমানো */
            font-size: 0.85em; /* অ্যাকশন বাটনের আইকন সাইজ আরও কমানো */
            margin: 1px; /* Margin কমানো */
            display: inline-block;
        }
        #channels-table .actions .edit-button-js { background-color: #007bff; }
        #channels-table .actions .delete-button { background-color: #dc3545; }
        #channels-table .actions .delete-form { display: inline-block; margin: 0; padding: 0; vertical-align: middle; }

        /* --- Other Styles --- */
        .error-message {
            color: #721c24;
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            padding: 8px 10px;
            border-radius: 3px;
            margin-bottom: 10px;
            font-size: 0.9em;
        }
        input[readonly] {
            background-color: #e9ecef;
            cursor: not-allowed;
        }

        /* --- Responsive Styles (Adjusted for smaller table font) --- */
        @media (max-width: 768px) {
             /* Form font size remains larger */
             .table-container table { font-size: 0.75em; } /* টেবিল ফন্ট আরও ছোট */
             #channels-table th, #channels-table td { padding: 2px 4px; }
             #channels-table .actions button { padding: 2px 5px; font-size: 0.8em; }
        }
        @media (max-width: 600px) {
             /* Optional: Hide less important columns */
             /*
             #channels-table th:nth-child(3), #channels-table td:nth-child(3) { display: none; } // Hide Logo
             #channels-table th:nth-child(4), #channels-table td:nth-child(4) { display: none; } // Hide Group
             */
        }
    </style>
</head>
<body>
    <h1>M3U Playlist Admin</h1>

    <div class="m3u-link">
        Your M3U Playlist URL: <a href="{{ url_for('generate_m3u_playlist', _external=True) }}" target="_blank">{{ url_for('generate_m3u_playlist', _external=True) }}</a>
    </div>

    {% if error %}
        <div class="error-message"><i class="fa-solid fa-circle-exclamation"></i> {{ error }}</div>
    {% endif %}

    <form id="channel-form" method="POST" action="{{ url_for('add_or_update_channel_m3u') }}">
        <h2 id="form-title">Add New Channel</h2>
        <input type="hidden" id="is_edit" name="is_edit" value="false">

        <label for="channel_id">Channel ID:</label>
        <input type="text" id="channel_id" name="channel_id" required pattern="^[a-zA-Z0-9_-]+$" title="Only letters, numbers, hyphens and underscores are allowed.">

        <label for="name">Channel Name:</label>
        <input type="text" id="name" name="name" required>

        <label for="logo_link">Logo Link (URL):</label>
        <input type="text" id="logo_link" name="logo_link">

        <label for="group_title">Group Title:</label>
        <input type="text" id="group_title" name="group_title">

        <label for="stream_link">Stream Link (URL):</label>
        <input type="text" id="stream_link" name="stream_link" required>

        <button type="submit" id="submit-button" title="Add New Channel">
            <i class="fa-solid fa-plus"></i> <span class="button-text">Add Channel</span>
        </button>
        <button type="button" id="cancel-edit-button" title="Cancel Edit">
            <i class="fa-solid fa-ban"></i> <span class="button-text">Cancel</span>
        </button>

        <p style="font-size: 0.85em; margin-top: 10px;"><em>Use the form to add. Click <i class="fa-solid fa-pencil fa-xs"></i> in the table to edit.</em></p>
    </form>

    <h2>Existing Channels</h2>
    {% if channels %}
        <div class="table-container">
            <table id="channels-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Name</th>
                        <th>Logo</th>
                        <th>Group</th>
                        <th>Stream Link</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for channel in channels %}
                        <tr data-id="{{ channel.channel_id }}"
                            data-name="{{ channel.name }}"
                            data-logo="{{ channel.logo_link | default('', true) }}"
                            data-group="{{ channel.group_title | default('', true) }}"
                            data-stream="{{ channel.stream_link }}">
                            <td>{{ channel.channel_id }}</td>
                            <td>{{ channel.name }}</td>
                            <td>
                                {% if channel.logo_link %}
                                    <img src="{{ channel.logo_link }}" alt="Logo" onerror="this.style.display='none'">
                                {% endif %}
                            </td>
                            <td>{{ channel.group_title }}</td>
                            <td title="{{ channel.stream_link }}">{{ (channel.stream_link[:20] + '...') if channel.stream_link|length > 20 else channel.stream_link }}</td>
                            <td class="actions">
                                <button type="button" class="edit-button-js" title="Edit Channel '{{ channel.name | escape }}'">
                                    <i class="fa-solid fa-pencil fa-xs"></i> </button>
                                <form class="delete-form" method="POST" action="{{ url_for('delete_m3u_channel', channel_id=channel.channel_id) }}" onsubmit="return confirm('Are you sure you want to delete channel \'{{ channel.name | escape }}\' ({{ channel.channel_id }})?');">
                                    <button type="submit" class="delete-button" title="Delete Channel '{{ channel.name | escape }}'">
                                        <i class="fa-solid fa-trash-can fa-xs"></i> </button>
                                </form>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <p>No channels found.</p>
    {% endif %}

    <script>
        // --- আগের জাভাস্ক্রিপ্ট কোড এখানে থাকবে ---
        // (No changes needed in JS for these specific requests)
        const channelForm = document.getElementById('channel-form');
        const formTitle = document.getElementById('form-title');
        const channelIdInput = document.getElementById('channel_id');
        const nameInput = document.getElementById('name');
        const logoLinkInput = document.getElementById('logo_link');
        const groupTitleInput = document.getElementById('group_title');
        const streamLinkInput = document.getElementById('stream_link');
        const isEditInput = document.getElementById('is_edit');
        const submitButton = document.getElementById('submit-button');
        const cancelEditButton = document.getElementById('cancel-edit-button');
        const channelsTable = document.getElementById('channels-table');
        const submitButtonTextSpan = submitButton.querySelector('.button-text');
        const submitButtonIcon = submitButton.querySelector('i');

        function resetFormToAddMode() {
            channelForm.reset();
            channelIdInput.readOnly = false;
            isEditInput.value = 'false';
            if (submitButtonTextSpan) submitButtonTextSpan.textContent = 'Add Channel';
            submitButton.title = 'Add New Channel';
            if (submitButtonIcon) submitButtonIcon.className = 'fa-solid fa-plus';
            submitButton.classList.remove('update-mode');
            formTitle.textContent = 'Add New Channel';
            cancelEditButton.style.display = 'none';

            const currentlyEditingRow = channelsTable ? channelsTable.querySelector('tr.editing') : null;
            if (currentlyEditingRow) {
                currentlyEditingRow.classList.remove('editing');
            }
        }

        if (channelsTable) {
            channelsTable.addEventListener('click', function(event) {
                const editButton = event.target.closest('.edit-button-js');

                if (editButton) {
                    const row = editButton.closest('tr');

                    const currentlyEditingRow = channelsTable.querySelector('tr.editing');
                     if (currentlyEditingRow && currentlyEditingRow !== row) {
                         currentlyEditingRow.classList.remove('editing');
                     }
                     row.classList.add('editing');

                    const id = row.dataset.id;
                    const name = row.dataset.name;
                    const logo = row.dataset.logo;
                    const group = row.dataset.group;
                    const stream = row.dataset.stream;

                    channelIdInput.value = id;
                    nameInput.value = name;
                    logoLinkInput.value = logo || '';
                    groupTitleInput.value = group || '';
                    streamLinkInput.value = stream;

                    channelIdInput.readOnly = true;
                    isEditInput.value = 'true';

                    if (submitButtonTextSpan) submitButtonTextSpan.textContent = 'Update Channel';
                    submitButton.title = 'Update Channel';
                     if (submitButtonIcon) submitButtonIcon.className = 'fa-solid fa-save';
                    submitButton.classList.add('update-mode');

                    formTitle.textContent = 'Edit Channel';
                    cancelEditButton.style.display = 'inline-block';

                    channelForm.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            });
        }

        cancelEditButton.addEventListener('click', resetFormToAddMode);

    </script>

</body>
</html>
